services:
  # 1. 데이터베이스 서비스
  mysqldb:
    image: mysql:latest
    container_name: mysqldb
    restart: always
    env_file: .env # .env 파일에 정의된 모든 변수를 컨테이너 환경변수로 로드
    environment:
      # .env에 작성된 변수들을 MySQL 설정에 매핑
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - "${DB_PORT}:3306" # 외부접속포트:컨테이너내부포트
    volumes:
      - db_data:/var/lib/mysql # 컨테이너가 삭제되어도 DB 데이터는 유지되도록 볼륨 설정

  # 2. Django 백엔드 서비스
  backend:
    build:
      context: . # 현재 디렉토리의 파일을 기반으로 이미지 빌드
      dockerfile: Dockerfile
    container_name: backend
    env_file: .env
    # Nginx를 통해서만 통신할 경우 expose 사용 (포트 8000을 내부 네트워크에만 공개)
    expose:
      - "8000"
    # 만약 Nginx 없이 브라우저에서 바로 8000으로 접속하고 싶다면 아래 주석 해제
    # ports:
    #   - "8000:8000"
    volumes:
      - ./:/app # 로컬 코드를 수정하면 컨테이너에 즉시 반영 (개발 편의성)
      - static_volume:/app/static # collectstatic으로 모인 파일을 저장할 공유 공간
    restart: always
    depends_on:
      - mysqldb # DB가 먼저 실행된 후 백엔드 실행
    command: >
      bash -c "python wait_mysql.py && 
      python manage.py collectstatic --noinput &&
      python manage.py migrate &&
      python manage.py collectstatic --noinput &&
      uvicorn config.asgi:application --host 0.0.0.0 --port 8000"
      # 설명: DB 대기 -> 마이그레이션 생성 및 적용 -> 정적 파일 수집 -> 서버 실행

  # 3. Nginx 웹 서버 (프록시 및 정적 파일 서빙)
  nginx:
    image: nginx:latest
    container_name: nginx
    ports:
      - "80:80" # 외부에서 80포트(HTTP)로 접속 허용
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf # 로컬의 설정을 Nginx에 주입
      - static_volume:/app/static # backend가 모아놓은 정적 파일을 공유받음
    depends_on:
      - backend

# 공용 볼륨 정의
volumes:
  db_data:       # MySQL 데이터 저장용
  static_volume: # Django와 Nginx 사이의 정적 파일 공유용