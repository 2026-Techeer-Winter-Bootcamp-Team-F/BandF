name: CD

on:
  workflow_run:
    workflows: [ "CI" ]
    types: [ completed ]
    branches: [ "main" ]

jobs:
  deploy:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: DockerHub Login
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and Push Docker Image
      uses: docker/build-push-action@v4
      with:
        context: ./Backend
        push: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/backend:latest

    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      env:
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        DB_ROOT_PASSWORD: ${{ secrets.DB_ROOT_PASSWORD }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        CODEF_CLIENT_ID: ${{ secrets.CODEF_CLIENT_ID }}
        CODEF_CLIENT_SECRET: ${{ secrets.CODEF_CLIENT_SECRET }}
        CODEF_CLIENT_PUBLIC: ${{ secrets.CODEF_CLIENT_PUBLIC }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        envs: DB_NAME,DB_USER,DB_PASSWORD,DB_ROOT_PASSWORD,SECRET_KEY,CODEF_CLIENT_ID,CODEF_CLIENT_SECRET,CODEF_CLIENT_PUBLIC,GEMINI_API_KEY
        script: |
          mkdir -p ~/app
          cd ~/app

          # Git 저장소 클론 또는 업데이트
          if [ -d Backend/.git ]; then
            cd Backend
            git fetch origin
            git reset --hard origin/main
            cd ..
          else
            rm -rf Backend
            git clone https://github.com/2026-Techeer-Winter-Bootcamp-Team-F/Backend.git
          fi

          # 환경 변수 파일 생성 (매 배포마다 갱신)
          printf '%s\n' \
            "DB_NAME=${DB_NAME}" \
            "DB_USER=${DB_USER}" \
            "DB_PASSWORD=${DB_PASSWORD}" \
            "DB_ROOT_PASSWORD=${DB_ROOT_PASSWORD}" \
            "DB_HOST=mysqldb" \
            "DB_PORT=3306" \
            "SECRET_KEY=${SECRET_KEY}" \
            "DEBUG=False" \
            "CODEF_CLIENT_ID=${CODEF_CLIENT_ID}" \
            "CODEF_CLIENT_SECRET=${CODEF_CLIENT_SECRET}" \
            "CODEF_CLIENT_PUBLIC=${CODEF_CLIENT_PUBLIC}" \
            "GEMINI_API_KEY=${GEMINI_API_KEY}" \
            > .env

          # 설정 파일 복사
          cp Backend/docker-compose.yml .
          cp Backend/docker-compose-monitoring.yml .
          cp -r Backend/prometheus .
          cp -r Backend/nginx . 2>/dev/null || true

          # docker-compose.yml 수정: build 대신 DockerHub 이미지 사용
          sed -i '/build:/,/dockerfile:/c\    image: ${{ secrets.DOCKERHUB_USERNAME }}/backend:latest' docker-compose.yml
          sed -i '/- \.\/Backend:\/app/d' docker-compose.yml

          # Docker 이미지 업데이트
          sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/backend:latest

          # 서비스 재시작
          sudo docker compose down 2>/dev/null || true
          sudo docker compose -f docker-compose-monitoring.yml down 2>/dev/null || true
          sudo docker compose up -d
          sudo docker compose -f docker-compose-monitoring.yml up -d

          echo "Waiting for services to start..."
          sleep 20

    - name: Health Check
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        script: |
          cd ~/app
          for i in {1..6}; do
            if curl -f http://localhost:8000/health/; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Waiting for application to be ready... ($i/6)"
            sleep 5
          done
          echo "Health check failed!"
          sudo docker compose ps
          sudo docker compose logs --tail 50 backend
          sudo docker compose logs --tail 20 mysqldb
          exit 1
