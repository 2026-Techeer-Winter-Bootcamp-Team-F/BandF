services:
  # 1. ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤
  mysqldb:
    image: mysql:latest
    container_name: mysqldb
    restart: always
    env_file: .env # .env íŒŒì¼ì— ì •ì˜ëœ ëª¨ë“  ë³€ìˆ˜ë¥¼ ì»¨í…Œì´ë„ˆ í™˜ê²½ë³€ìˆ˜ë¡œ ë¡œë“œ
    environment:
      # .envì— ì‘ì„±ëœ ë³€ìˆ˜ë“¤ì„ MySQL ì„¤ì •ì— ë§¤í•‘
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - "${DB_PORT}:3306" # ì™¸ë¶€ì ‘ì†í¬íŠ¸:ì»¨í…Œì´ë„ˆë‚´ë¶€í¬íŠ¸
    volumes:
      - db_data:/var/lib/mysql # ì»¨í…Œì´ë„ˆê°€ ì‚­ì œë˜ì–´ë„ DB ë°ì´í„°ëŠ” ìœ ì§€ë˜ë„ë¡ ë³¼ë¥¨ ì„¤ì •
    networks:
      - app-network

  # 2. Django ë°±ì—”ë“œ ì„œë¹„ìŠ¤
  backend:
    build:
      context: ./Backend # í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ íŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ì´ë¯¸ì§€ ë¹Œë“œ
      dockerfile: Dockerfile
    container_name: backend
    env_file: .env
    # Nginxë¥¼ í†µí•´ì„œë§Œ í†µì‹ í•  ê²½ìš° expose ì‚¬ìš© (í¬íŠ¸ 8000ì„ ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ì—ë§Œ ê³µê°œ)
    expose:
      - "8000"
    # ë§Œì•½ Nginx ì—†ì´ ë¸Œë¼ìš°ì €ì—ì„œ ë°”ë¡œ 8000ìœ¼ë¡œ ì ‘ì†í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
    ports:
      - "8000:8000"
    volumes:
      # ğŸ”¥ Hot Reload: ë¡œì»¬ ì½”ë“œ ë³€ê²½ ì‹œ ì»¨í…Œì´ë„ˆì— ì¦‰ì‹œ ë°˜ì˜
      - ./Backend:/app
      # ìºì‹œ íŒŒì¼ì€ ë¡œì»¬ê³¼ ê²©ë¦¬ (ì„±ëŠ¥ í–¥ìƒ)
      - /app/__pycache__
      - /app/**/__pycache__
      # ì •ì  íŒŒì¼ ê³µìœ 
      - static_volume:/app/static
    restart: always
    depends_on:
      - mysqldb # DBê°€ ë¨¼ì € ì‹¤í–‰ëœ í›„ ë°±ì—”ë“œ ì‹¤í–‰
    networks:
      - app-network
    # ğŸ”¥ --reload í”Œë˜ê·¸ë¡œ ì½”ë“œ ë³€ê²½ ìë™ ê°ì§€
    command: >
      bash -c "python wait_mysql.py &&
      python manage.py collectstatic --noinput &&
      python manage.py migrate &&
      python manage.py collectstatic --noinput &&
      uvicorn config.asgi:application --host 0.0.0.0 --port 8000 --reload --reload-include '*.py' --reload-exclude '__pycache__/*'"
      # ì„¤ëª…: DB ëŒ€ê¸° -> ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„± ë° ì ìš© -> ì •ì  íŒŒì¼ ìˆ˜ì§‘ -> ì„œë²„ ì‹¤í–‰ (Hot Reload í™œì„±í™”)

  # 3. Nginx ì›¹ ì„œë²„ (í”„ë¡ì‹œ ë° ì •ì  íŒŒì¼ ì„œë¹™)
  nginx:
    image: nginx:latest
    container_name: nginx
    ports:
      - "80:80" # ì™¸ë¶€ì—ì„œ 80í¬íŠ¸(HTTP)ë¡œ ì ‘ì† í—ˆìš©
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf # ë¡œì»¬ì˜ ì„¤ì •ì„ Nginxì— ì£¼ì…
      - static_volume:/app/static # backendê°€ ëª¨ì•„ë†“ì€ ì •ì  íŒŒì¼ì„ ê³µìœ ë°›ìŒ
    depends_on:
      - backend
    networks:
      - app-network

  # 4. Prometheus ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ë° ì €ì¥
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: always
    ports:
      - "9090:9090"  # Prometheus UI ì ‘ì† í¬íŠ¸
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml  # Prometheus ì„¤ì • íŒŒì¼
      - prometheus_data:/prometheus  # ë©”íŠ¸ë¦­ ë°ì´í„° ì €ì¥ìš© ë³¼ë¥¨
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    depends_on:
      - backend
    networks:
      - app-network

  # 5. Grafana ë©”íŠ¸ë¦­ ì‹œê°í™” ëŒ€ì‹œë³´ë“œ
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: always
    ports:
      - "3000:3000"  # Grafana UI ì ‘ì† í¬íŠ¸
    environment:
      - GF_SECURITY_ADMIN_USER=admin  # ê¸°ë³¸ ê´€ë¦¬ì ê³„ì •
      - GF_SECURITY_ADMIN_PASSWORD=admin  # ê¸°ë³¸ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ (ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ë°˜ë“œì‹œ ë³€ê²½)
      - GF_USERS_ALLOW_SIGN_UP=false  # íšŒì›ê°€ì… ë¹„í™œì„±í™”
    volumes:
      - grafana_data:/var/lib/grafana  # Grafana ë°ì´í„° ì €ì¥ìš© ë³¼ë¥¨
    depends_on:
      - prometheus
    networks:
      - app-network

# ê³µìš© ë³¼ë¥¨ ì •ì˜
volumes:
  db_data:       # MySQL ë°ì´í„° ì €ì¥ìš©
  static_volume: # Djangoì™€ Nginx ì‚¬ì´ì˜ ì •ì  íŒŒì¼ ê³µìœ ìš©
  prometheus_data: # Prometheus ë©”íŠ¸ë¦­ ë°ì´í„° ì €ì¥ìš©
  grafana_data:    # Grafana ì„¤ì • ë° ëŒ€ì‹œë³´ë“œ ì €ì¥ìš©

networks:
  app-network:
